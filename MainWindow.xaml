<Window x:Class="PkgInspector.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:PkgInspector"
        mc:Ignorable="d"
        Title="Package Inspector" 
        Height="850" Width="1000"
        Icon="/Resources/app-icon.png"
        Background="{DynamicResource BackgroundBrush}"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" 
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="â—€" 
                            Style="{StaticResource ModernButton}"
                            Click="Home_Click"
                            Width="36"
                            Height="36"
                            Padding="0"
                            Margin="0,0,12,0"
                            ToolTip="Back to Welcome Screen"
                            FontSize="16"
                            Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    <Image Source="/Resources/package-icon.png" 
                           Width="32" Height="32" 
                           Margin="0,0,12,0"
                           Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    <StackPanel VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding PackageName}" 
                                       Style="{StaticResource SubHeaderText}"
                                       Margin="0,0,12,0"
                                       Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <Border Background="{Binding IsSigned, Converter={StaticResource SignatureBrushConverter}}"
                                    CornerRadius="3"
                                    Padding="8,4"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="{Binding SignatureStatus, Mode=OneWay}" 
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="White"/>
                            </Border>
                        </StackPanel>
                        <TextBlock Text="{Binding PackageFileName}" 
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Export..." 
                            Style="{StaticResource ModernButton}"
                            Click="ExportPackage_Click"
                            Padding="16,10"
                            Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Content Area -->
        <Grid Grid.Row="1">
            <!-- Welcome Screen -->
            <local:WelcomeControl x:Name="WelcomeScreen"
                                  Visibility="{Binding HasPackage, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                                  PackageSelected="WelcomeScreen_PackageSelected"/>

            <!-- Tabs - Fill entire width to prevent any peek-through -->
            <Grid Visibility="{Binding HasPackage, Converter={StaticResource BoolToVisibilityConverter}}">
                <!-- Full-width background to cover Welcome Screen's Recent Packages sidebar -->
                <Rectangle Fill="{DynamicResource BackgroundBrush}" />
                
                <TabControl x:Name="MainTabControl"
                            Background="Transparent"
                            Margin="0">
                
                <!-- Package Info Tab -->
                <TabItem Header="ðŸ“‹ Package Info">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
                        <StackPanel>
                            <!-- Package Overview -->
                            <Border Background="{DynamicResource SurfaceBrush}" 
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12"
                                    Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="Package Overview" 
                                               Style="{StaticResource SubHeaderText}"
                                               Margin="0,0,0,8"/>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding PackageInfo.Name}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Version:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding PackageInfo.Version}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Description:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PackageInfo.Description}" Style="{StaticResource ValueText}" TextWrapping="Wrap" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Author:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding PackageInfo.Author}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="4" Grid.Column="0" Text="License:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding PackageInfo.License}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Homepage:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="5" Grid.Column="1" Style="{StaticResource ValueText}" Margin="0,0,0,4">
                                            <Hyperlink NavigateUri="{Binding PackageInfo.Homepage}" RequestNavigate="Hyperlink_RequestNavigate">
                                                <TextBlock Text="{Binding PackageInfo.Homepage}"/>
                                            </Hyperlink>
                                        </TextBlock>
                                    </Grid>
                                    
                                    <!-- Signature Badge -->
                                    <Border Background="{Binding IsSigned, Converter={StaticResource SignatureBrushConverter}}"
                                            CornerRadius="4"
                                            Padding="8,4"
                                            HorizontalAlignment="Left"
                                            Margin="0,4,0,0">
                                        <TextBlock FontSize="12"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   TextWrapping="Wrap">
                                            <Run Text="{Binding SignatureStatus, Mode=OneWay}"/><Run Text=" "/><Run Text="{Binding SignedBy, Mode=OneWay}" FontWeight="Normal"/>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Installation Details -->
                            <Border Background="{DynamicResource SurfaceBrush}" 
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12"
                                    Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="Installation Details" 
                                               Style="{StaticResource SubHeaderText}"
                                               Margin="0,0,0,8"/>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Install Location:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding PackageInfo.InstallLocation}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Restart Action:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding PackageInfo.RestartAction}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="File Count:" Style="{StaticResource LabelText}" Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding FileCount}" Style="{StaticResource ValueText}" Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Script Count:" Style="{StaticResource LabelText}"/>
                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ScriptCount}" Style="{StaticResource ValueText}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Dependencies -->
                            <Border Background="{DynamicResource SurfaceBrush}" 
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12"
                                    Visibility="{Binding HasDependencies, Converter={StaticResource BoolToVisibilityConverter}}">
                                <StackPanel>
                                    <TextBlock Text="Dependencies" 
                                               Style="{StaticResource SubHeaderText}"
                                               Margin="0,0,0,8"/>
                                    <ItemsControl ItemsSource="{Binding PackageInfo.Dependencies}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" 
                                                           Style="{StaticResource ValueText}"
                                                           Margin="0,0,0,4"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- All Files Tab -->
                <TabItem Header="ðŸ“ All Files">
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" 
                                   Text="{Binding FileCountMessage}" 
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   Margin="8,8,8,12"/>

                        <TreeView Grid.Row="1" 
                                  x:Name="FilesTreeView"
                                  ItemsSource="{Binding FileTree}"
                                  SelectedItemChanged="FilesTreeView_SelectedItemChanged"
                                  MouseRightButtonDown="FilesTreeView_RightClick">
                            <TreeView.ContextMenu>
                                <ContextMenu x:Name="FileContextMenu">
                                    <MenuItem Header="Export Item..." Click="ExportFileItem_Click"/>
                                    <MenuItem Header="Open With" x:Name="OpenWithMenuItem">
                                        <MenuItem Header="Loading..." IsEnabled="False"/>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="Copy Path" Click="CopyFilePath_Click"/>
                                </ContextMenu>
                            </TreeView.ContextMenu>
                            <TreeView.ItemTemplate>
                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Icon}" 
                                                   FontSize="16" 
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding Name}" 
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SizeFormatted}" 
                                                   FontSize="11"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   Margin="8,0,0,0"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </Grid>
                </TabItem>

                <!-- All Scripts Tab -->
                <TabItem Header="ðŸ“œ All Scripts">
                    <Grid Margin="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="250"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" 
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,0,1,0"
                                Padding="0,0,16,0">
                            <ListBox x:Name="ScriptsListBox"
                                     ItemsSource="{Binding Scripts}"
                                     DisplayMemberPath="Name"
                                     SelectionChanged="ScriptsListBox_SelectionChanged"
                                     MouseRightButtonDown="ScriptsListBox_RightClick"
                                     BorderThickness="0">
                                <ListBox.ContextMenu>
                                    <ContextMenu x:Name="ScriptContextMenu">
                                        <MenuItem Header="Export Script..." Click="ExportScriptItem_Click"/>
                                        <MenuItem Header="Open With" x:Name="OpenScriptWithMenuItem">
                                            <MenuItem Header="Loading..." IsEnabled="False"/>
                                        </MenuItem>
                                        <Separator/>
                                        <MenuItem Header="Copy Script Path" Click="CopyScriptPath_Click"/>
                                    </ContextMenu>
                                </ListBox.ContextMenu>
                            </ListBox>
                        </Border>

                        <Grid Grid.Column="1" Margin="16,0,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,12">
                                <TextBlock Text="{Binding SelectedScript.Name}" 
                                           Style="{StaticResource SubHeaderText}"/>
                                <TextBlock Text="{Binding SelectedScript.Type}" 
                                           FontSize="12"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                            <Border Grid.Row="1" 
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                            HorizontalScrollBarVisibility="Auto">
                                    <TextBox Text="{Binding SelectedScript.Content, Mode=OneWay}" 
                                             IsReadOnly="True"
                                             FontFamily="Consolas"
                                             FontSize="12"
                                             BorderThickness="0"
                                             Background="{DynamicResource SurfaceBrush}"
                                             Padding="12"
                                             TextWrapping="NoWrap"
                                             VerticalScrollBarVisibility="Disabled"
                                             HorizontalScrollBarVisibility="Disabled"/>
                                </ScrollViewer>
                            </Border>
                        </Grid>
                    </Grid>
                </TabItem>

                <!-- Metadata Tab -->
                <TabItem Header="â„¹ï¸ Metadata">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
                        <Border Background="{DynamicResource SurfaceBrush}" 
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="20">
                            <StackPanel>
                                <TextBlock Text="Raw Metadata (build-info.yaml)" 
                                           Style="{StaticResource SubHeaderText}"
                                           Margin="0,0,0,12"/>
                                <TextBox Text="{Binding RawMetadata, Mode=OneWay}" 
                                         IsReadOnly="True"
                                         FontFamily="Consolas"
                                         FontSize="12"
                                         BorderThickness="0"
                                         Background="{DynamicResource SurfaceBrush}"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         Padding="12"
                                         TextWrapping="Wrap"
                                         MinHeight="400"/>
                            </StackPanel>
                        </Border>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
            </Grid>
        </Grid>
    </Grid>
</Window>
